sudo apt update && sudo apt upgrade

# Copy k3s folder to ~

# On Kube1
sudo apt install ansible nano 

# Create first server
curl -sfL https://get.k3s.io | K3S_TOKEN=***REMOVED*** sh -s - server --cluster-init --disable servicelb,traefik,local-storage --write-kubeconfig-mode 644 --disable-cloud-controller

# Run next Ansible script
ansible-playbook ~/k3s/ansible-k3s-post.yaml --ask-become-pass

# Restart k3s on each node in turn
systemctl restart k3s

# Install Autocomplete
sudo apt install -y bash-completion
echo "source <(kubectl completion bash)" >> ~/.bashrc
source ~/.bashrc


# Install Helm
curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
sudo apt-get install apt-transport-https --yes
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
sudo apt-get update
sudo apt-get install helm

# Copy K3S config to home dir
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config

# install MetalLB
helm repo add metallb https://metallb.github.io/metallb 
helm install --create-namespace -n metallb-system metallb metallb/metallb -n metallb-system
kubectl apply -f ~/k3s/metallb/ip-pool.yaml
kubectl apply -f ~/k3s/metallb/l2-advertise.yaml

# Install Traefik
helm repo add traefik https://helm.traefik.io/traefik
helm repo update
helm install --create-namespace traefik traefik/traefik --namespace=traefik --values ~/k3s/traefik/values.yaml
kubectl apply -f ~/k3s/traefik/

# Install ArgoCD
helm repo add argocd https://argoproj.github.io/argo-helm
helm install argocd argocd/argo-cd --namespace=argocd --create-namespace --values ~/k3s/argocd/argocd-values.yaml
kubectl apply -f ~/k3s/argocd/

# May have to follow this for Longhorn volume creation issues:
https://longhorn.io/kb/troubleshooting-volume-with-multipath/



######################################################################################
##                  Install remote admin tools on non-K3S server                    ##
######################################################################################
sudo curl -fsSLo /etc/apt/keyrings/kubernetes-archive-keyring.gpg https://packages.cloud.google.com/apt/doc/apt-key.gpg
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main" | sudo tee /etc/apt/sources.list.d/kubernetes.list
sudo apt update
sudo apt install -y kubectl

mkdir ~/.kube
# copy k3s.yaml to file called "config" in .kube folder

# Install Autocomplete
sudo apt install -y bash-completion
echo "source <(kubectl completion bash)" >> ~/.bashrc
source ~/.bashrc



######################################################################################
## Everything below should get deployed via ArgoCD. The below is just for reference ##
######################################################################################

# Install Longhorn
helm repo add longhorn https://charts.longhorn.io
helm repo update
helm install --create-namespace -n longhorn longhorn longhorn/longhorn --values ~/k3s/longhorn/values.yaml

# Add Longhorn dashboard access
kubectl delete service longhorn-frontend -n longhorn
kubectl apply -f ~/k3s/longhorn/longhorn-service.yaml
kubectl apply -f ~/k3s/longhorn/dashboard-ingress.yaml

# Add local-path storage class
kubectl apply -f https://raw.githubusercontent.com/rancher/local-path-provisioner/v0.0.23/deploy/local-path-storage.yaml

# Install NFS server for Longhorn
kubectl apply -f ~/k3s/nfs-backup

# In Longhorn, go to Settings - General and set the backup target to: nfs://nfs-server-svc.nfs-server:/

# Add Portainer
helm repo add portainer https://portainer.github.io/k8s/
helm repo update
helm install --create-namespace -n portainer portainer portainer/portainer --values ~/k3s/portainer/values.yaml
kubectl apply -f ~/k3s/portainer/dashboard-ingress.yaml

# Install local registry
kubectl apply -f ~/k3s/registry/
docker push registry.ucdialplans.com/dxp-base-image
docker push registry.ucdialplans.com/epc-groupupdate
docker push registry.ucdialplans.com/epc-groupupdate-jb
docker push registry.ucdialplans.com/epc-testmonitor
docker push registry.ucdialplans.com/epc-activecount
docker push registry.ucdialplans.com/dxp-in-license-check
docker push registry.ucdialplans.com/garminupload
docker push registry.ucdialplans.com/ucdialplans

# Install Prometheus/Grafana monitoring 
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update
helm install --create-namespace -n monitoring promstack prometheus-community/kube-prometheus-stack --values ~/k3s/monitoring/promstack-values.yaml
kubectl apply -f ~/k3s/monitoring/helm-ingress-prometheus.yaml
kubectl apply -f ~/k3s/monitoring/helm-ingress-alertmanager.yaml
kubectl apply -f ~/k3s/monitoring/helm-ingress-grafana.yaml
kubectl apply -f ~/k3s/monitoring/grafana-secrets.yaml

# Install Loki
helm repo add grafana https://grafana.github.io/helm-charts
helm install -n monitoring loki grafana/loki-stack --values  ~/k3s/monitoring/loki-values.yaml

# Install MariaDB
helm repo add bitnami https://charts.bitnami.com/bitnami
kubectl apply -f ~/k3s/mariadb/pv.yaml
helm install --create-namespace -n mariadb mariadb -f ~/k3s/mariadb/values.yaml bitnami/mariadb-galera
helm install --create-namespace -n mariadb-standalone mariadb-standalone -f ~/k3s/mariadb-standalone/values bitnami/mariadb
kubectl apply -f ~/k3s/mariadb-backup/